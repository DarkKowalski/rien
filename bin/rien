#!/bin/ruby

require 'optparse'
require 'rien'

options = {
  mode: :help
}

parser = OptionParser.new do |opts|
  opts.banner = 'Usage: rien [options]'
  opts.on('-e', '--encode [FILE]', 'Encode specific ruby file', String) do |v|
    options[:mode] = :encode
    options[:file] = v
  end

  # opts.on('-p', '--pack [FILE]', 'Pack ruby file and all relative requirements into a single executable', String) do |v|
  #   options[:mode] = :pack
  #   options[:file] = v
  # end
end

parser.parse!

case options[:mode]
when :encode
  encoder = Rien::Encoder.new
  bytes = encoder.encode_file(options[:file])
  generated_name = "#{options[:file]}.encoded.rb"
  bootstrap = encoder.bootstrap(generated_name)

  File.open(generated_name, 'w') do |f|
    f.write bootstrap
  end

  File.open("#{generated_name}.rien", 'wb') do |f|
    f.write bytes
  end
when :help
  puts parser
else
  puts parser
end
